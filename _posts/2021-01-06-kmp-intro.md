---
title: Kotlin Multiplatform Intro
tags: Kotlin Android iOS Compose Desktop Multiplatform
key: kotlin-multiplatform-intro

---

![](/assets/images/kmp.png)

Working at a company that has a native app for Android, iOS and the Web, all of which are written in separate languages. I have been on a mission to figure out a way to share code between all of these platforms and Kotlin Multiplatform(KMP) is a promising solution that aims to do just this by working with each native platform as opposed to some of the other solutions like Flutter or React Native which build a whole framework on top of each native platform. 

Over this series of articles on KMP, I am going to try to gradually work through building up a simple TODO app that will have common code to be shared between Android, iOS, Web, and Desktop. 

In this introduction, I will walk through how to setup the project and get the TODO app to work on the Desktop and Android using [Jetpack Compose Desktop](https://www.jetbrains.com/lp/compose/). 

<!--more-->

## Project Setup


The first thing you need to get started is Jetbrains [IntelliJ IDE Community Edition](https://www.jetbrains.com/idea/download/) 220.3 or newer. Once installed create a new project, give it a name, select the Kotlin Jetpack compose desktop multiplatform, and click next. 

![](/assets/images/kmp-new-project.png)

Later in this post we will be creating a `shared-code` module, so let's quickly rename the `common` module to `composeui` to avoid the confusion on what the `common` module would mean. The `composeui` module will contain all of the UI code that will be shared between Android and desktop apps. Finally click finish and wait for the IDE to index and sync everything. 

![](/assets/images/kmp-rename-common.png)

### Running the Project

Once the IDE has synced all of the initial dependencies, you should be able to run a hello world app for Android and the desktop. 

#### Running on Android

In the top toolbar select an Android app configuration, an Android device to install on, then the play button. 

![](/assets/images/kmp-run-android.png)

#### Running on Desktop 

To run from the command line you can use the gradle wrapper on the project to run the desktop app. 

```bash
./gradlew :desktop:run
```

If you want to run the desktop app from the IDE, you can create a gradle configuration that is accessible from the top toolbar. Where the Android app configuration was selected earlier, open up the dropdown and select `Edit Configuration`. Add a new gradle configuration in the top left with the plus button and give it a name if you like. For project path, you can click on the blue folder to select the `desktop` module and then set the tasks to `run`. 

![](/assets/images/kmp-dekstop-configuration.png)

Now you should be able to switch between running the Android or desktop app through the toolbar in IntelliJ. 

## Create a Shared Code Module

Now we are going to create a new `shared-code` module which will contain all of the app's business logic that can be shared between each platform. To create a new module click on `File -> New.. -> Module..`, then select a gradle multiplatform with the Kotlin DSL build script checked. 

![](/assets/images/kmp-new-module.png)

Make the parent the project, give the module a name and click finish. 

![](/assets/images/kmp-new-module-name.png)

At this point, you should actually be getting errors in the IDE and thats because this only sets up a new folder, `build.gradle.kts` file, and adds the module to `settings.gradle.kts` file. There is some configuration needed for this new `build.gradle.kts` file and the `shared-code` module to remove these errors which deserves an explanation of how KMP is structured to understand what will be done next. 

### KMP Structure

What makes Kotlin Multiplatform a great solution for sharing code is how it shares this code by compiling common Kotlin code into each native target. So the way this code is structured can be seen in the following diagram. 

![](/assets/images/kmp-todo-shared-code.png)

The `commonMain` source set is what contains all of the shared Kotlin code and is platform agnostic by *expecting* properties or functions to be implemented. Each platform target depends on the `commonMain` source set and each target has its own source set which has the *actual* platform implementation. 

To learn more about this subject, I recommend looking at the [official documentation](https://kotlinlang.org/docs/reference/multiplatform.html) as it goes into a little bit more depth. 


### Configuring build.gradle.kts

Replace the code in `shared-code/build.gradle.kts` with the following configuration and sync gradle in the IDE. 

```kotlin
plugins {
    kotlin("multiplatform")
    id("com.android.library")
}

group = "com.plusmobileapps"
version = "1.0"

repositories {
    mavenCentral()
    google()
    jcenter()
}

kotlin {
    //these are the targets in this module
    //so android and desktop target are declared
    android()
    jvm("desktop") {
        compilations.all {
            kotlinOptions.jvmTarget = "11"
        }
    }

    //the source set for shared code and targets
    sourceSets {
        val commonMain by getting {
            dependencies {
                implementation(kotlin("stdlib-common"))
            }
        }
        val commonTest by getting {
            dependencies {
                implementation(kotlin("test-common"))
                implementation(kotlin("test-annotations-common"))
            }
        }

        val androidMain by getting {
            dependencies {
                api("androidx.appcompat:appcompat:1.2.0")
                api("androidx.core:core-ktx:1.3.1")
            }
        }
        val androidTest by getting {
            dependencies {
                implementation("junit:junit:4.13")
            }
        }
        val desktopMain by getting {
            dependencies {
            }
        }
        val desktopTest by getting

    }
}

//needed to compile the android library
android {
    compileSdkVersion(29)
    sourceSets["main"].manifest.srcFile("src/androidMain/AndroidManifest.xml")
    defaultConfig {
        minSdkVersion(24)
        targetSdkVersion(29)
    }

    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_1_8
        targetCompatibility = JavaVersion.VERSION_1_8
    }

}

//this will help prevent an error later which can be thrown if Kotlin is compiled with Java 6
tasks.withType<org.jetbrains.kotlin.gradle.tasks.KotlinCompile> {
    kotlinOptions {
        jvmTarget = "1.8"
    }
}
```

### Add Source Sets

Once the IDE has synced the new gradle file, you should be able to quickly add the source sets for the desktop and Android by right clicking on the `shared-code` folder -> New.. -> Directory. Select the `commonMain/kotlin` and `desktopMain/kotlin` shortcuts from the window. 


![](/assets/images/kmp-desktop-common.png)

I have found adding the Android source set is a little more tedious, but KMP is also in alpha when this is written so hopefully this will improve later. In the meantime, in the `shared-code` folder create a new folder `androidMain` and then a `kotlin` folder inside of that. Then create a new file in `androidMain` called `AndroidManifest.xml`. All that is needed in this file so far is the following. 


```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.plusmobileapps.sharedcode"/>
```

Now sync gradle and cross your fingers that all the errors are gone. 

### Create First Shared Code

In a Multiplatform world, it would be hard to write all code in the common module as there is usually some platform specific code that is needed such as a driver for a database. KMP addresses this problem with the `expect` and `actual` keyword. So the common module can `expect` to have a function, class, or property. Then each platform target can implement the `actual` implementation for what the common code should expect. 

So we will create a simple function that will return the platform the code is running on. In the `shared-code/commonMain/kotlin` folder, create a package name and create a `Platform.kt` file. The IDE should be giving an error with a solution to fix the problem and that is because there needs to be an actual implementation for the code to compile. 

![](/assets/images/kmp-implement-actual.png)

Select the `desktopMain` option first and implement the actual function. 

```kotlin
actual fun platform(): String = "Desktop"
```

Android again is a little bit more tedious as the JVM option will not actually create the right file in the `androidMain/kotlin` folder(Hope this gets fixed). So you will need to create the same package and `Platform.kt` file in `androidMain` then implement the actual implementation. 

```kotlin
actual fun platform(): String = "Android"
```

### Use the Shared Code

In the `composeui` `build.gradle.kts` file, add the `shared-code` module to the dependencies and sync gradle again. 

```kotlin
val commonMain by getting {
    dependencies {
        implementation(project(":shared-code"))
    }        
}
```

After the IDE syncs, open up the `App.kt` file in the `composeui` module in the `commonMain` folder to use the `platform()` function. 

```kotlin
import com.plusmobileapps.sharedcode.platform

@Composable
fun App() {
    var text by remember { mutableStateOf("Hello, World!") }

    MaterialTheme {
        Button(onClick = {
            text = "Hello, ${platform()}"
        }) {
            Text(text)
        }
    }
}
```

Run the app and you should now see the platform message change on each platform when the button is clicked. Here is a [commit](https://github.com/plusmobileapps/todo-kmp/commit/3505f92ee829b8ab44e6af118aab24fe810b948c) with all of these changes in creating the shared code module. 

## Create Dependencies File

In order to be able to maintain versions of all of the dependencies across different modules, there is a way to create a Kotlin file which can be accessed across every `build.gradle.kts` file and that is with the magic of the `buildSrc` folder. 

To do this, create a new `buildSrc` directory in the root of the project. 

```
mkdir buildSrc
mkdir -p buildSrc/src/main/java
```

Then make a `build.gradle.kts` file in the `buildSrc` folder with the following: 

```kotlin
repositories {
    jcenter()
}

plugins {
    `kotlin-dsl`
}

kotlinDslPluginOptions {
    experimentalWarning.set(false)
}
```

A `.gitignore` file will also help you prevent checking in any build files. 

```
build/
```

Now you can create a `Dependencies.kt` file in the `buildSrc/src/main/java` and be able to access it across all gradle files. 

```kotlin
//Dependencies.kt
object Deps {
    object Android {
        const val targetSdk = 29
    }
}

//build.gradle.kts
android {
    defaultConfig {
        targetSdkVersion(Deps.Android.targetSdk)
    }
}
```

I will leave it as homework to clean up all of the dependencies if you have been coding along, but you can find this work in this [commit](https://github.com/plusmobileapps/todo-kmp/commit/595074617c7e74ae423297a81d0f362e6e56af00). Through out the rest of these articles though, this is where all dependencies will be declared for reference. 

If you wish to learn some more cool things to do with the `buildSrc` and gradle, I encourage you to read this [post](https://www.jrebel.com/blog/using-buildsrc-custom-logic-gradle-builds) from Jrebel. 


## Create a Todo Repository 

### Configure Database

To persist all of the data, [SQL Delight](https://github.com/cashapp/sqldelight) is a KMP library from the folks at Cash app that allows you to share SQLite code between Android, iOS, and the desktop. To configure SQLDelight in the project, first download the IntelliJ plugin from [here](https://plugins.jetbrains.com/plugin/8191-sqldelight) and then open up the project's `build.gradle.kts` file to add the following. 

First you can add all of the SQLDelight dependencies to the file we just created in the last section. 

```kotlin
object Squareup {
    object SQLDelight {
        private const val VERSION = "1.4.4"
        const val gradlePlugin = "com.squareup.sqldelight:gradle-plugin:$VERSION"
        const val androidDriver = "com.squareup.sqldelight:android-driver:$VERSION"
        const val sqliteDriver = "com.squareup.sqldelight:sqlite-driver:$VERSION"
        const val coroutineExtensions = "com.squareup.sqldelight:coroutines-extensions:$VERSION"
    }
}
```

Then in the project root `build.gradle.kts` file, add the SQLDelight gradle plugin.  

```kotlin
buildscript {
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath(Deps.Squareup.SQLDelight.gradlePlugin)
    }
}
```

Then in the `shared-code` `build.gradle.kts` file, add the plugin,  dependencies to each source set, and the SQL Delight configuration. 

```kotlin
plugins {
    id("com.squareup.sqldelight")
}

kotlin {
    sourceSets {
        val commonMain by getting {
            dependencies {
                implementation(Deps.JetBrains.Kotlin.coroutines)  {
                    version {
                        strictly(Deps.JetBrains.Kotlin.COROUTINES_VERSION)
                    }
                }
                implementation(Deps.Squareup.SQLDelight.coroutineExtensions)
            }
        }

        val androidMain by getting {
            dependencies {
                implementation(Deps.Squareup.SQLDelight.androidDriver)
            }
        }
        val desktopMain by getting {
            dependencies {
                implementation(Deps.Squareup.SQLDelight.sqliteDriver)
            }
        }
    }
}

sqldelight {
    database("MyDatabase") {
        packageName = "com.plusmobileapps.sharedcode.db"
        sourceFolders = listOf("sqldelight")
    }
}
```

Now in the `shared-code` module, create a package to what you just declared above in `packageName` and this will now be where you can write the `.sq` files. Create a `Todo.sq` file and add the following to create a table in the database and some functions Kotlin can call. 

```
CREATE TABLE Todo(
id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
text TEXT NOT NULL,
is_checked INTEGER AS Boolean NOT NULL DEFAULT 0
);

insertItem:
INSERT OR REPLACE INTO Todo(text)VALUES(?);

selectAll:
SELECT * FROM Todo;

toggleChecked:
UPDATE Todo
SET is_checked = ?
WHERE id = ?;

updateText:
UPDATE Todo
SET text = ?
WHERE id = ?;

deleteAll:
DELETE FROM Todo;

deleteChecked:
DELETE FROM Todo
WHERE is_checked = 1;

deleteItem:
DELETE FROM Todo
WHERE id = ?;
```

### Creating the Database

If everything was configured correctly, you should be able to now create a file in the `shared-code` common module where we can expect the database. 

```kotlin
import com.plusmobileapps.sharedcode.db.MyDatabase

expect fun createDb(): MyDatabase
```

Then we can implement the actual implementation of this function for each target. For Android

```kotlin
lateinit var context: Context

actual fun createDb(): MyDatabase {
    val driver = AndroidSqliteDriver(MyDatabase.Schema, context, "database.db")
    return MyDatabase.invoke(driver)
}
```

## Resources 

* [Github Repository](https://github.com/plusmobileapps/todo-kmp)